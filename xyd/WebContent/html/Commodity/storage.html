<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>商品入库</title>
<link href="/xyd/css/bootstrap/bootstrap.min.css" rel="stylesheet">
<link href="/xyd/css/bootstrap/bootstrap-table.css" rel="stylesheet">
</head>
<body>
  <!-- 头选择商品部分 -->
  <nav aria-label="breadcrumb">
	<ol class="breadcrumb">
	  <li class="breadcrumb-item">衣服 : </li>
      <li class="breadcrumb-item"><a href="#">Home</a></li>
	  <li class="breadcrumb-item"><a href="#">Library</a></li>
	  <li class="breadcrumb-item"><a href="#">Data</a></li>
	</ol>
	<ol class="breadcrumb">
      <li class="breadcrumb-item">裤子 : </li>
	  <li class="breadcrumb-item"><a href="#">Library</a></li>
	  <li class="breadcrumb-item active" aria-current="page">Data</li>
	</ol>
	<ol class="breadcrumb">
	  <li class="breadcrumb-item">鞋子: </li>
      <li class="breadcrumb-item"><a id="add" value="120.5" href="#">Home</a></li>
	  <li class="breadcrumb-item"><a href="#">Library</a></li>
	  <li class="breadcrumb-item active" aria-current="page">Data</li>
	</ol>
  </nav>
  
  <!-- table数据展示部分 -->
  <div id="main">
  	<div id="toolbar">
    	<button id="remove" class="btn btn-default">remove</button>
    </div>
    <table id="table" class="container table-striped"
    	data-toggle="table"
        data-toolbar="#toolbar"
        data-pagination="true"
        data-show-export="true">
        <thead>
	        <tr>
	        	<th data-field="state" data-checkbox="true"></th>
	            <th data-field="id">#</th>
	            <th data-field="name">条目名称</th>
	            <th data-field="color">颜色</th>
	            <th data-field="nums">数量</th>
	            <th data-field="price">推荐单价(元)</th>
	            <th data-field="component">备注</th>
	        </tr>
        </thead>
    </table>
    
    <form class="form-inline">
    	<div class="form-group row col-sm-12">
    		<div class="col-sm-10"></div>
    		<button id="go_check" type="button" class="btn btn-primary" data-toggle="modal" data-target="#checkModal" style="margin-top:5px;">
    			去结算
    		</button>
    	</div>
	</form>
    
  </div>
  
  <!-- Modal -->
  <div class="modal fade" id="checkModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="exampleModalLabel">订单信息</h5>
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	          <span aria-hidden="true">&times;</span>
	        </button>
	      </div>
	      <div class="modal-body">
	        <div id="itemList">
	        	
	        </div>
	        <hr/>
	        <div class="container">
			  <div class="row">
			    <div class="col-sm-4">
			      	<label for="discount" class="col-form-label">整体折扣</label>
			    </div>
			    <div class="col-sm-8">
			        <select class="form-control" id="discount">
			    	  <option value="100">无折扣</option>
				      <option value="98">9.8折</option>
				      <option value="95">9.5折</option>
				      <option value="90">9.0折</option>
				      <option value="88">8.8折</option>
				      <option value="85">8.5折</option>
				      <option value="80">8.0折</option>
				    </select>
			    </div>
			  </div>
			  <div class="row" style="margin-top:5px;">
			    <div class="col-sm-4">
			      <label for="total_amount" class="col-form-label">总金额</label>
			    </div>
			    <div class="col-sm-8">
			    	<div class="input-group">
						<div class="input-group-prepend">
					    	<span class="input-group-text">￥</span>
					  	</div>
					  	<input type="text" class="form-control" id="total_amount" aria-label="Amount (to the nearest dollar)" value="0">
					</div>
			    </div>
			  </div>
			</div>
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭订单</button>
	        <button type="button" class="btn btn-primary">确认订单</button>
	      </div>
	    </div>
	  </div>
  </div>
    
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script>window.jQuery || document.write('<script src="/xyd/js/bootstrap/jquery-slim.min.js"><\/script>')</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script src="/xyd/js/bootstrap/bootstrap-table.js"></script>
<script type="text/javascript">
var total = 0;
//传入单价，返回总价.永远表示无折扣总价
function getTotal(itemprice){
	var lastPrice = parseFloat(total);
  	total = lastPrice + itemprice;
	return total;
}
//传入折扣，返回总价
function getTotalByDiscount(discount){
	var result = total*(discount/100);
	return result;
}
//展示总价
function showTotal(total){
	$("#total_amount").val(total);
}
var map = new Object(); // or var map = {};

function get(k) {
    return map[k];
}


$(function () {
	
	var changedList = [""];
	
	var $table = $('#table');
	var $add = $('#add');
	$add.click(function () {
	    var randomId = 100 + ~~(Math.random() * 100);
	    var itemName = $(this).html();
	    var i = 0;
	    var itemprice = parseFloat($(this).attr("value"));
	    var text = ' <input type="text" class="form-control" value="'+itemName+'">'
	    var select = '<select class="form-control color_select">';
	    	select+= '<option value="black">黑色</option>';
	    	select+= '<option value="black">黑色</option>';
	    	select+= '<option value="black">黑色</option>';
	    	select+= '<option value="black">黑色</option>';
	    	select+= '<option value="black">黑色</option>';
	    	select+= '<option value="black">黑色</option>';
	    	select+= '<option value="black">黑色</option>';
	    	select+= '<option value="black">黑色</option>';
	    	select+= '</select>';
	    var nums = '<select class="form-control nums_select">';
    		nums+= '<option value="1">1</option>';
    		nums+= '<option value="2">2</option>';
    		nums+= '<option value="3">3</option>';
    		nums+= '<option value="4">4</option>';
    		nums+= '<option value="5">5</option>';
    		nums+= '</select>';
	    var component = ' <input type="text" class="form-control" placeholder="备注可不填写">';
	    
	    /* 获取总价格,后展示 */
	    showTotal(getTotal(itemprice));
	    
	    $table.bootstrapTable('insertRow', {
	        index: i++,
	        row: {
	            id: randomId,
	            name: text,
	            color: select,
	            nums: nums,
	            price: itemprice,
	            component: component
	        }
	    });
	});
	
	//去结算
	$("#go_check").click(function(){
		//全选
		$("#itemList").empty();
		
		$table.bootstrapTable('checkAll');
		$.map($table.bootstrapTable('getSelections'), function (row) {
			console.log($(row.nums).val());
			var itemColor = $(row.color).val();
			var itemName = $(row.name).val();
			var itemNums = parseFloat($(row.nums).children(".nums_select").children("option:selected").val());
			var itemPrice = parseFloat(row.price);
			var itemComponent = $(row.component).val()
			var content = '<p>'+itemColor+"&nbsp;"+itemName+"&nbsp;"+itemPrice+" * "+itemNums+" 备注:"+itemComponent+'</p>'
			$("#itemList").append(content);
            console.log(row);
            /* console.log($(row.nums).val()); */
        });
	})
	
	//折扣
	$("#discount").change(function(){
		console.log(total);
		var discount = parseFloat($("#discount").val());
		var disTotal = getTotalByDiscount(discount);
		showTotal(disTotal);
	});
	
	//删除
	var $remove = $('#remove');
	$remove.click(function () {
        var ids = $.map($table.bootstrapTable('getSelections'), function (row) {
            return row.id;
        });
        $table.bootstrapTable('remove', {
            field: 'id',
            values: ids
        });
    });
	
	//更换下拉菜单选项后写入临时map
	$table.on("change",".nums_select",function(){
		var rowId = $(this).parent().siblings().eq(1).html();
		var itemName = $($(this).parent().siblings().eq(2).html()).val();
		var color = $(this).parent().siblings().eq(3).val();
		var nums = $(this).val();
		var price = $(this).parent().siblings().eq(5).html();
		var component = $(this).parent().siblings().eq(6).val();
		
        var rowContent = new Object();
        rowContent.id = rowId;
        rowContent.name = itemName;
        rowContent.color = color;
        rowContent.nums = nums;
        
        map[rowId] = rowContent;
        
        console.log(map[rowId]);
        console.log(get[rowId]);
        
    });
	
	/* $("#table").on("change",".add_select",function(){
        $(this). find(".picBox_in").show()
    }).on("mouseleave",".picBox",function(){
        $(this). find(".picBox_in").hide()
    }) */
});
</script>
</body>
</html>